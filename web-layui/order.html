<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script type="text/javascript" src="include/title.js"></script>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <script type="text/javascript" src="include/admin/side.js"></script>
    <script type="text/javascript" src="include/admin/header.js"></script>
    <script type="text/javascript" src="include/admin/footer.js"></script>

    <div class="layui-body">
        <table id="table" lay-filter="table"></table>
    </div>

    <div id="detailModal" style="display: none;">
        <div style="width: 500px; margin: 0 auto; padding: 20px;">
            <table id="table2" lay-filter="table2"></table>
        </div>
    </div>
</div>
<script type="text/html" id="toolbarTpl">
    <input class="text" style="height:30px;width:200px;" name="" id="keyword"  placeholder="请输入关键词">
     <a href="javascript:void(0);" id="search">
        <i class="layui-icon layui-icon-search"></i> 
    </a>
</script>
<script type="text/html" id="iconTpl">
    <img src="{{ d.icon }}" width="50px" height="50px">
</script>
<script type="text/html" id="barTpl">
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="detail">详情</a>
    {{# if (d.orderStatus == '新订单' && d.payStatus == '未付款') { }}
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="close">关闭订单</a>
    {{# } else if (d.orderStatus == '买家申请退款') { }}
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="deal">处理退款</a>
    {{# } else if (d.orderStatus == '新订单') { }}
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="refund">主动退款</a>
    <a class="layui-btn layui-btn-success layui-btn-xs" lay-event="finish">完成</a>
    {{# } }}
</script>
<script>
    layui.use(['jquery', 'element', 'table', 'form'], function () {
        var $ = layui.jquery;
        var table = layui.table;

        // $('#search').click(function(){}); 搜索一次后会失效
        $('body').on('click', '#search', function () {
            table.reload('table', {
                // url: 'seller/order/list',
                where: {keyword: $('#keyword').val()}
            });
        });

        table.render({
            elem: '#table',
            url: 'seller/order/list',
            page: true,
            size: 'lg',
            toolbar: '#toolbarTpl', // 'default'
            cols: [[
                {field: 'id', title: 'ID', width: 100, align: 'center', sort: true, edit: true},
                {field: 'username', title: '用户名'},
                {field: 'amount', title: '总金额'},
                {field: 'orderStatus', title: '订单状态'},
                {field: 'payStatus', title: '支付状态'},
                {field: 'createTime', title: '创建时间'},
                {field: 'updateTime', title: '修改时间'},
                {fixed: 'right', title: '操作', width: 200, toolbar: '#barTpl'}
            ]]
        });

        // 监听行工具事件
        table.on('tool(table)', function (obj) {
            switch (obj.event) {
                case 'detail':
                    layer.open({
                        type: 1, // 0：信息框，默认 1：页面层 2：iframe层 3：加载层 4：tips层
                        title: '订单详情',
                        content: $('#detailModal'),
                        area: ['800px', 200 + 50 * obj.data.products.length + 'px'],
                        shadeClose: true,
                        success: function () {
                            table.render({
                                elem: '#table2',
                                data: obj.data.products,
                                size: 'lg',
                                cols: [[
                                    {field: 'id', title: 'ID', width: 100, align: 'center', sort: true, edit: true},
                                    {field: 'icon', title: '图标', width: 100, align: 'center', templet: '#iconTpl'},
                                    {field: 'name', title: '名称'},
                                    {field: 'price', title: '价格'},
                                    {field: 'quantity', title: '数量'},
                                ]]
                            });
                        }
                    });
                    break;
                case 'finish':
                    layer.confirm('确认完成？', function (index) {
                        $.post('seller/pay/finish/' + obj.data.id, function (res) {
                            if (res.code === 0) {
                                table.reload('table', {page: {curr: $(".layui-laypage-em").next().html()}});
                            }
                        });
                    });
                    break;
                case 'close':
                    layer.confirm('确认关闭订单？', function (index) {
                        $.post('seller/pay/close/' + obj.data.id, function (res) {
                            if (res.code === 0) {
                                table.reload('table', {page: {curr: $(".layui-laypage-em").next().html()}});
                            }
                        });
                    });
                    break;
                case 'deal':
                    layer.confirm('确认处理退款？', function (index) {
                        $.post('seller/pay/deal/' + obj.data.id, function (res) {
                            if (res.code === 0) {
                                table.reload('table', {page: {curr: $(".layui-laypage-em").next().html()}});
                            }
                        });
                    });
                    break;
                case 'refund':
                    layer.confirm('确认主动退款？', function (index) {
                        $.post('seller/pay/refund/' + obj.data.id, function (res) {
                            if (res.code === 0) {
                                table.reload('table', {page: {curr: $(".layui-laypage-em").next().html()}});
                            }
                        });
                    });
                    break;
            }
        });
    });
</script>
</body>
</html>
