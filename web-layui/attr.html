<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script type="text/javascript" src="include/admin/title.js"></script>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <script type="text/javascript" src="include/admin/side.js"></script>
    <script type="text/javascript" src="include/admin/header.js"></script>
    <script type="text/javascript" src="include/admin/footer.js"></script>

    <div class="layui-body">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px">
            <legend>上传属性</legend>
        </fieldset>
        <div style="width: 1000px; margin: 0 auto;">
            <form id="form" class="layui-form layui-form-pane" autocomplete="off">
                <div class="layui-form-item">
                    <label class="layui-form-label">选择分类</label>
                    <div class="layui-input-block">
                        <div id="category"></div>
                    </div>
                </div>

                <div id="sku"></div>

                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">JSON</label>
                    <div class="layui-input-block">
                        <textarea id="content" class="layui-textarea"></textarea>
                    </div>
                </div>

                <div class="layui-form-item">
                    <a class="layui-btn layui-btn-fluid" id="test">测试</a>
                </div>
            </form>
        </div>
    </div>
</div>
<script type="text/html" id="barTpl">
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="add">添加</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete">删除</a>
</script>
<script>
    layui.config({
        base: 'layui/lay/extend/'
    }).extend({
        xmSelect: 'xm-select', // https://gitee.com/maplemei/xm-select
        sku: 'sku' // https://github.com/yinxu46/sku
    }).use(['jquery', 'element', 'xmSelect', 'sku'], function () {
        var $ = layui.jquery, xmSelect = layui.xmSelect, sku = layui.sku;

        var categoryId;
        var skuData;
        $.get('category/list', function (res) {
            xmSelect.render({
                el: '#category',
                tips: '请选择分类',
                name: 'category',
                layVerify: 'required',
                model: {icon: 'hidden', label: {type: 'text'}},
                radio: true,
                clickClose: true,
                tree: {
                    show: true,
                    strict: false,
                    expandedKeys: true,
                },
                data: res.data,
                prop: {value: 'id'},
                on: function (data) {
                    if (!data.isAdd) return;
                    categoryId = data.change[0].id;
                    $.get('sku/attr/' + categoryId, function (res) {
                        skuData = res.data;
                        initOp(); // 初始化
                    });
                },
            });
        });

        function initOp() {
            var SKU = sku.init({id: 'sku', item: skuData, data: []});

            $('#test').click(function () {
                console.log(SKU.getData());
                $('#content').val(JSON.stringify(SKU.getData()) + '\n' + JSON.stringify(SKU.getItem()));
            });

            $('i[name="addName"]').click(function () {
                layer.prompt({
                    formType: 0, // 0（文本）默认1（密码）2（多行文本）
                    value: 'name',
                    title: '请输入属性名',
                    area: ['800px', '400px']
                }, function (value, index, elem) {
                    $.post('sku/name/' + categoryId, {name: value}, function (res) { // name
                        if (res.code === 0) {
                            skuData.push(res.data); // add
                            initOp();
                        }
                        layer.close(index);
                    });
                });
            });

            $('i[name="addValue"]').click(function (e) {
                layer.prompt({
                    formType: 0, // 0（文本）默认1（密码）2（多行文本）
                    value: 'value',
                    title: '请输入属性值',
                    area: ['800px', '400px']
                }, function (value, index, elem) {
                    var attributeId = $(e.currentTarget).attr('data-id');
                    $.post('sku/value/' + attributeId, {value: value}, function (res) { // value
                        if (res.code === 0) {
                            $.each(skuData, function (i, item) {
                                if (item.id === attributeId) {
                                    skuData[i].sub.push(res.data); // add
                                    return false;
                                }
                            });
                            initOp();
                        }
                        layer.close(index);
                    });
                });
            });

            $('i[name="deleteName"]').click(function (e) {
                layer.confirm('确认删除属性名？', function (index) {
                    var nameId = $(e.currentTarget).attr('data-id');
                    $.delete('sku/name/' + nameId, function (res) {
                        if (res.code === 0) {
                            $.each(skuData, function (i, item) {
                                if (item.id === nameId) {
                                    skuData.splice(i, 1); // delete
                                    return false;
                                }
                            });
                            initOp();
                        }
                        layer.close(index);
                    });
                });
            });

            $('i[name="deleteValue"]').click(function (e) {
                layer.confirm('确认删除属性值？', function (index) {
                    var valueId = $(e.currentTarget).attr('data-id');
                    $.delete('sku/value/' + valueId, function (res) {
                        if (res.code === 0) {
                            $.each(skuData, function (i, item) {
                                $.each(item.sub, function (i2, item2) {
                                    if (item2.id === valueId) {
                                        skuData[i].sub.splice(i2, 1); // delete
                                        return false;
                                    }
                                });
                            });
                            initOp();
                        }
                        layer.close(index);
                    });
                });
            });
        }
    });
</script>
</body>
</html>
